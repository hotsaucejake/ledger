# RFC-003: CLI Command Taxonomy & UX Rules

**Status:** Draft (Revised)
**Audience:** Core maintainers, contributors
**Applies to:** Ledger v0.1+

---

## 1. Purpose

This RFC defines:

* The **command structure** of the Ledger CLI
* How commands behave in interactive vs scripted use
* Rules for flags, prompts, defaults, and errors
* Query expression planning for structured data
* UX guarantees that keep Ledger fast, predictable, and composable

The goal is a CLI that:

* Feels natural to humans
* Is scriptable by machines
* Scales from casual journaling to power-user workflows

---

## 2. Core CLI Philosophy

Ledger follows five non-negotiable CLI principles:

### 2.1 Verb-First Commands

Commands start with **what you want to do**, not what you want to act on.

```bash
ledger add journal
ledger list todo
ledger search "anxious"
```

This mirrors tools like `git`, `kubectl`, and `docker`.

### 2.2 Interactive by Default, Scriptable Always

* If input is missing → prompt
* If input is provided → never prompt
* Flags always override prompts
* `--no-input` disables prompts entirely

Ledger must *never* block automation.

### 2.3 Safe Defaults, Explicit Power

* Defaults are sensible
* Destructive actions require confirmation
* Power features exist but are opt-in

### 2.4 Discoverability Over Cleverness

* `ledger help`
* `ledger help add`
* `ledger types show weight`
* Clear error messages
* Suggestions when user mistypes

### 2.5 Fast Paths for Daily Use

Ledger must optimize for commands used **every day**, not just edge cases.

---

## 3. Command Topology

### 3.1 Phase 0.1 Commands

```
ledger
├── add <type>
├── list [type]
├── search <query>
├── show <id>
├── check
├── backup
└── help
```

### 3.2 Phase 0.2+ Commands

```
ledger
├── add <type>
├── list [type]
├── search <query>
├── show <id>
├── edit <id>        (limited)
├── attach <id> <composition>
├── detach <id> <composition>
├── types
│   ├── list
│   ├── show <type>
│   ├── create <type>
│   └── delete <type>
├── compositions     (see RFC-006)
│   ├── list
│   ├── show <name>
│   ├── create <name>
│   └── delete <name>
├── tags
│   ├── list
│   └── rename <old> <new>
├── export
├── check
├── backup
└── help
```

Each command has a **single responsibility**.

---

## 4. `ledger add`

### 4.1 Purpose

Create a new entry of a given type.

```bash
ledger add <type> [flags] [field values]
```

### 4.2 Behavior

| Case                      | Behavior                              |
| ------------------------- | ------------------------------------- |
| Type exists               | Enter entry-creation mode             |
| Type does not exist       | Error with suggestion (see RFC-002)   |
| `--create` flag           | Create type if missing, then add      |
| Flags provided            | Skip prompts for those fields         |
| Missing required fields   | Prompt interactively                  |
| `--no-input`              | Error if required fields missing      |

### 4.3 Examples

```bash
# Phase 0.1: only journal type
ledger add journal

# Phase 0.2+: user-defined types
ledger add weight
ledger add weight --weight 175.5
ledger add todo --task "Write RFC" --due tomorrow
ledger add --create mood   # creates type if missing
```

### 4.4 Common Flags

| Flag          | Description                    | Phase |
| ------------- | ------------------------------ | ----- |
| `--tag`, `-t` | Add tag(s)                     | 0.1   |
| `--date`      | Override timestamp             | 0.1   |
| `--no-input`  | Disable prompts                | 0.1   |
| `--create`    | Create type if it doesn't exist | 0.2   |
| `--yes`       | Auto-confirm prompts           | 0.1   |
| `--compose`   | Associate with composition(s)  | 0.2   |
| `--no-compose`| Skip default composition       | 0.2   |

### 4.5 Stdin Support (Phase 0.1)

For text fields, content can be piped from stdin:

```bash
cat notes.txt | ledger add journal
echo "Quick thought" | ledger add journal --tag idea
ledger add journal < existing_entry.md
```

This provides an escape hatch for:
* Bulk import of existing text
* Scripted entry creation
* Migration from other tools

When stdin is not a TTY and no `--body` flag is provided, Ledger reads the text field from stdin instead of opening `$EDITOR`.

---

## 5. `ledger list`

### 5.1 Purpose

List entries, optionally filtered by type.

```bash
ledger list [type] [filters]
```

### 5.2 Filters

| Flag           | Description              | Phase |
| -------------- | ------------------------ | ----- |
| `--last <N>d`  | Time window              | 0.1   |
| `--since DATE` | Start date               | 0.1   |
| `--until DATE` | End date                 | 0.1   |
| `--tag TAG`    | Filter by tag            | 0.1   |
| `--limit N`    | Limit results            | 0.1   |
| `--json`       | Output JSON              | 0.1   |
| `--compose`    | Filter by composition    | 0.2   |

### 5.3 Examples

```bash
ledger list                    # all entries
ledger list journal            # only journal entries
ledger list --last 7d          # last 7 days
ledger list weight --json      # machine-readable
ledger list --compose project_x  # entries in composition (Phase 0.2)
```

---

## 6. Query Expressions (Planned: Phase 0.3+)

### 6.1 The Problem

For structured data, `--last 30d` and `--tag` aren't enough. Users will want:

```bash
ledger list weight --where "weight > 180"
ledger list todo --where "completed = false AND due < tomorrow"
```

### 6.2 Planned Syntax

A minimal expression language for filtering:

```
<field> <operator> <value>
```

Operators:
* `=`, `!=` — equality
* `>`, `<`, `>=`, `<=` — comparison
* `contains` — substring match
* `AND`, `OR` — logical operators

### 6.3 Examples

```bash
ledger list weight --where "weight > 180"
ledger list todo --where "completed = false"
ledger list journal --where "body contains 'anxious'"
```

### 6.4 Phase Rollout

| Feature | Phase |
|---------|-------|
| Basic filters (`--last`, `--tag`) | 0.1 |
| Simple `--where` expressions | 0.3 |
| Complex expressions (AND/OR) | 1.0 |
| Saved queries | 1.0+ |

### 6.5 Design Constraints

* Query syntax must be simple enough to type
* Must work in shell without excessive quoting
* Error messages must explain what's wrong
* No SQL exposure to users

### 6.6 Stability Guarantees

Once query expressions ship:

* The query language is **versioned** (reported in `ledger --version`)
* Invalid queries must error loudly with explanations
* Query semantics are stable once released
* New operators extend, never change existing behavior

This prevents "jq syndrome" where early syntax decisions become permanent accidents.

---

## 7. `ledger search`

### 7.1 Purpose

Full-text search across entries.

```bash
ledger search <query> [filters]
```

### 7.2 Behavior

* Uses FTS index (see RFC-004 for what's indexed)
* Searches text fields + structured text
* Returns entries ordered by relevance

### 7.3 Examples

```bash
ledger search anxious
ledger search "panic attack"
ledger search anxious --last 90d
ledger search anxious --type journal
```

---

## 8. `ledger show`

### 8.1 Purpose

Display a single entry in detail.

```bash
ledger show <id>
```

### 8.2 Behavior

* Pretty-prints structured fields
* Renders text fields (markdown optional)
* Shows schema version, tags, timestamps
* Shows entry UUID for reference

### 8.3 ID Formats

Ledger accepts:

* Full UUID: `ledger show 550e8400-e29b-41d4-a716-446655440000`
* Short prefix: `ledger show 550e8400` (if unambiguous)
* Relative: `ledger show @last` (most recent entry)

---

## 9. `ledger edit` (Phase 0.2+, Limited)

### 9.1 Philosophy

Ledger entries are **log records**, not documents.

Editing is allowed but discouraged. Editing creates a **revision** — the original data remains recoverable.

```bash
ledger edit <id>
```

### 9.2 Behavior

* Opens entry in `$EDITOR`
* On save, creates new revision
* Original entry marked as superseded
* `ledger show <id> --history` shows all revisions

---

## 10. `ledger types` (Phase 0.2+)

### 10.1 Purpose

Manage entry types (schemas).

```bash
ledger types                   # list all types
ledger types list              # same
ledger types show weight       # show schema details
ledger types create mood       # create new type
ledger types delete mood       # delete type (if no entries)
```

See RFC-002 for full schema management details.

---

## 11. `ledger tags`

### 11.1 Purpose

Inspect and manage tag usage.

```bash
ledger tags                    # list all tags with counts
ledger tags list               # same
ledger tags rename old new     # rename across all entries
```

---

## 12. `ledger export`

### 12.1 Purpose

Extract data for backup or analysis.

```bash
ledger export [type] [filters] --format <format>
```

### 12.2 Formats

| Format | Description |
|--------|-------------|
| `json` | Array of entries |
| `jsonl` | One entry per line |
| `csv` | For structured types (Phase 0.3+) |

### 12.3 Examples

```bash
ledger export --json
ledger export journal --since 2025-01-01
ledger export weight --format csv
```

---

## 13. `ledger check` & `ledger backup`

### 13.1 Health & Safety

```bash
ledger check      # integrity check
ledger backup     # safe copy
```

These commands must be:

* Quiet on success
* Loud and explicit on failure

### 13.2 Check Output

```
Ledger: /home/user/.ledger
Status: OK
Entries: 1,247
Types: 5
Size: 2.3 MB
Last entry: 2026-01-07 14:32
```

Or on failure:

```
Ledger: /home/user/.ledger
Status: ERROR
Problem: FTS index out of sync (3 entries missing)
Hint: Run `ledger repair` to fix
```

---

## 14. Output Rules

### 14.1 Human vs Machine Output

Rules:

* Default output is human-friendly
* `--json` switches to machine output
* No mixed output modes
* Errors go to stderr
* Exit codes are meaningful

This allows:

```bash
ledger list weight --json | jq '.[] | .data.weight'
```

### 14.2 Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | General error |
| 2 | Invalid arguments |
| 3 | Entry not found |
| 4 | Schema error |
| 5 | Encryption/auth error |

---

## 15. Error UX Rules (Critical)

Ledger must:

* Never panic
* Never silently ignore errors
* Always explain *what* failed and *why*
* Suggest next steps

Example:

```
Error: Entry type "weight" does not exist.
Did you mean: weights?
Hint: Run `ledger types create weight` to create it.
      Or use `ledger add --create weight` for implicit creation.
```

---

## 16. Aliases & Shortcuts

Ledger supports:

* Command aliases: `ls → list`, `s → search`
* Type aliases (Phase 0.3+): `w → weight`

Aliases are configured in ledger settings, not shell config.

---

## 17. Configuration

### 17.1 Config Location

```
~/.config/ledger/config.toml
```

Or `$LEDGER_CONFIG` environment variable.

### 17.2 Config Options (Phase 0.1)

```toml
[core]
ledger_path = "~/.ledger"
editor = "$EDITOR"

[display]
date_format = "%Y-%m-%d"
time_format = "%H:%M"
```

### 17.3 Ledger Path Override

```bash
ledger --ledger ~/work.ledger add journal
LEDGER_PATH=~/work.ledger ledger add journal
```

---

## 18. UX Guarantees

Ledger guarantees:

* No data loss without confirmation
* No prompts in `--no-input` mode
* Deterministic behavior
* Backward compatibility of commands
* Meaningful error messages

---

## 19. Phase Rollout Summary

| Command | Phase 0.1 | Phase 0.2 | Phase 0.3+ |
|---------|-----------|-----------|------------|
| `add journal` | Yes | Yes | Yes |
| `add <custom>` | No | Yes | Yes |
| `list` | Yes | Yes | Yes |
| `search` | Yes | Yes | Yes |
| `show` | Yes | Yes | Yes |
| `edit` | No | Limited | Yes |
| `types` | No | Yes | Yes |
| `tags` | No | Yes | Yes |
| `export` | Basic | Yes | CSV |
| `--where` queries | No | No | Yes |
| Aliases | No | No | Yes |

---

## 20. Why This CLI Works

This taxonomy:

* Feels familiar to Git/Docker users
* Supports explicit schema management with guardrails
* Keeps the happy path short
* Avoids flag soup
* Scales without breaking muscle memory
* Plans for power features without front-loading complexity
