# RFC-002: Entry Types, Fields, and Schema Evolution

**Status:** Draft (Revised)
**Audience:** Core maintainers, contributors
**Applies to:** Ledger v0.1+

---

## 1. Purpose

This RFC defines how **entry types** (e.g. `weight`, `todo`, `journal`) are:

* Created (with guardrails)
* Stored
* Prompted
* Validated
* Evolved over time

It formalizes schema management while preventing common user errors.

---

## 2. Core Concepts

### 2.1 Entry Type

An **Entry Type** is a named schema that defines:

* Which fields an entry has
* Their types
* Defaults
* Validation rules
* Prompting behavior

Examples:

* `journal`
* `weight`
* `todo`
* `mood`
* `meeting_notes`

Entry types are **user-defined**, stored inside the encrypted ledger, and versioned.

### 2.2 Entry

An **Entry** is an instance of an entry type.

Each entry:

* Has a globally unique ID (UUID)
* References an entry type + schema version
* Contains structured data (JSON)
* Has timestamps, tags, and device metadata
* Is immutable once written (append-only model)

### 2.3 Built-in Entry Type: `journal`

Phase 0.1 ships with one built-in entry type:

```json
{
  "name": "journal",
  "version": 1,
  "builtin": true,
  "fields": [
    {
      "name": "body",
      "type": "text",
      "required": true
    }
  ]
}
```

This allows immediate use without schema definition:

```bash
ledger add journal
```

User-defined schemas come in Phase 0.2.

---

## 3. Schema Creation (With Guardrails)

### 3.1 The Problem with Silent Schema Creation

If `ledger add weight` silently creates a new entry type when `weight` doesn't exist:

* Typos create garbage schemas (`ledger add wieght`)
* Users don't realize they're defining structure
* No opportunity to catch mistakes

### 3.2 Explicit Creation by Default

Entry types are created explicitly:

```bash
ledger types create weight
```

This:

1. Confirms intent to create a new entry type
2. Prompts for field definitions
3. Validates the schema
4. Persists schema as version 1

### 3.3 Using Existing Types

Once a type exists:

```bash
ledger add weight
```

This:

1. Loads the latest active schema for `weight`
2. Prompts for field values
3. Applies defaults and validation
4. Writes entry

If the type doesn't exist, **error with suggestion**:

```
Error: Entry type "weight" does not exist.
Hint: Run `ledger types create weight` to create it.
      Or use `ledger add --create weight` to create and add in one step.
```

### 3.4 Opt-in Schema-on-First-Use

For users who want the convenience of implicit creation:

```bash
ledger add --create weight
```

This:

1. If `weight` exists → use it
2. If `weight` doesn't exist → enter schema creation mode, then create entry

Additionally, Ledger will prompt for confirmation when a type doesn't exist:

```
Entry type "weight" does not exist.
Do you want to create it now? [y/N]
```

### 3.5 Typo Detection

When a type doesn't exist, Ledger checks for similar names:

```
Error: Entry type "wieght" does not exist.
Did you mean: weight?
Hint: Run `ledger add weight` to use the existing type.
```

This uses fuzzy matching (Levenshtein distance) against existing type names.

---

## 4. Field Model

### 4.1 Field Definition

Each field in a schema has:

| Attribute    | Required | Description                |
| ------------ | -------- | -------------------------- |
| `name`       | Yes      | Unique within entry type   |
| `type`       | Yes      | Field type                 |
| `required`   | No       | Defaults to false          |
| `default`    | No       | Optional default value     |
| `prompt`     | No       | Override prompt text       |
| `order`      | No       | Display / positional order |
| `nullable`   | No       | Explicitly allow null      |
| `deprecated` | No       | Hide from prompts          |
| `searchable` | No       | Include in FTS index (default: true for text types) |

### 4.2 Supported Field Types (v1)

**Primitive**

* `string` — single-line text
* `number` — float
* `integer`
* `boolean`

**Temporal**

* `date` — YYYY-MM-DD
* `datetime` — ISO-8601

**Text**

* `text` — multiline, opens `$EDITOR`

**Special**

* `tags` — merged with entry tags
* `enum` — constrained to allowed values (Phase 0.3+)

Field types are **intentionally limited** in Phase 0.1/0.2.

---

## 5. Prompting Rules

### 5.1 Interactive Prompting

For each field:

* Prompt in defined order
* Show default if present
* Allow empty input if optional

Example:

```
Weight: 175.5
Date [today]:
```

### 5.2 Flags Override Prompts

Fields can be supplied via flags:

```bash
ledger add weight --weight 175.5 --date 2026-01-09
```

Rules:

* Flags bypass prompts
* Missing fields fall back to prompts
* Defaults apply only if no value provided

### 5.3 Non-Interactive Mode

```bash
ledger add weight --weight 175.5 --no-input
```

Rules:

* Errors if required fields are missing
* Applies defaults
* Never prompts

---

## 6. Defaults, Required, Nullable (Strict Semantics)

These three concepts must remain distinct.

| Concept    | Meaning                       |
| ---------- | ----------------------------- |
| `required` | Entry invalid if missing      |
| `default`  | Used if user supplies nothing |
| `nullable` | Explicitly allows null        |

Rules:

* `required + default` is allowed (default satisfies requirement)
* `required + nullable` is contradictory → error
* `default` does **not** imply required

---

## 7. Validation Lifecycle

Validation happens in **three stages**:

### 7.1 Schema Validation (on creation)

* Unique field names
* Valid field types
* Defaults match field type
* No contradictory flags

### 7.2 Input Validation (on entry creation)

* Required fields present
* Values match field types
* Enums match allowed values
* Dates parse correctly

### 7.3 Persistence Validation

* JSON serialization succeeds
* Schema version exists
* Entry references valid type/version

---

## 8. Storage Representation

### 8.1 Entry Types Table (conceptual)

```
entry_types
- id (UUID)
- name
- created_at
```

### 8.2 Entry Type Versions Table (conceptual)

```
entry_type_versions
- id (UUID)
- entry_type_id
- version
- schema_json
- created_at
- active (bool)
```

Schemas are stored as JSON blobs describing fields.

### 8.3 Entries Table (conceptual)

```
entries
- id (UUID)
- entry_type_id
- schema_version
- data_json
- tags_json
- created_at
- device_id
```

Data is **opaque JSON** validated by schema at write time.

---

## 9. Schema Versioning Rules

* New schemas increment `version`
* Old schemas remain immutable
* Entries reference exact schema version
* Ledger always uses latest active version for new entries

### What can change between versions?

* Fields added (new entries will prompt for them)
* Defaults changed
* Fields deprecated (hidden from prompts, still stored)

### What cannot change?

* Field types (would break existing entries)
* Field names (would break existing entries)

### Migration strategy (Phase 1.0+)

* No automatic rewriting of old entries
* Future versions may support migration tooling
* User consent always required

---

## 10. Schema Management Commands

### 10.1 List Types

```bash
ledger types list
ledger types                    # alias
```

Output:

```
journal (builtin)  - 1 version, 42 entries
weight             - 2 versions, 180 entries
todo               - 1 version, 15 entries
```

### 10.2 Show Type Details

```bash
ledger types show weight
```

Output:

```
Entry Type: weight
Version: 2 (active)
Created: 2026-01-01

Fields:
  weight  number   required
  date    date     default: today
  notes   text     optional (added in v2)
```

### 10.3 Create Type

```bash
ledger types create mood
```

Interactive prompts for field definitions.

### 10.4 Delete Type (Dangerous)

```bash
ledger types delete mood --confirm
```

* Requires explicit confirmation
* Only allowed if no entries exist for this type
* Or with `--force` (marks entries as orphaned)

### 10.5 Rename Type (Phase 1.0+)

```bash
ledger types rename wieght weight
```

Updates all entry references.

---

## 11. Canonical Examples

### 11.1 Weight Entry Type

Schema:

```json
{
  "name": "weight",
  "version": 1,
  "fields": [
    {
      "name": "weight",
      "type": "number",
      "required": true,
      "prompt": "Weight"
    },
    {
      "name": "date",
      "type": "date",
      "default": "today"
    }
  ]
}
```

Usage:

```bash
ledger types create weight          # define schema
ledger add weight                   # prompted entry
ledger add weight --weight 175.5    # partial flags
```

### 11.2 Todo Entry Type

```json
{
  "name": "todo",
  "version": 1,
  "fields": [
    { "name": "task", "type": "string", "required": true },
    { "name": "due", "type": "date" },
    { "name": "completed", "type": "boolean", "default": false }
  ]
}
```

---

## 12. Design Constraints (Intentional)

* Entry schemas live **inside the encrypted ledger**
* No external config files required
* Schema creation must be possible fully via CLI
* Schema evolution must never invalidate old data
* Typos must be caught before creating garbage schemas

---

## 13. Phase Rollout

| Feature | Phase 0.1 | Phase 0.2 | Phase 1.0 |
|---------|-----------|-----------|-----------|
| Built-in `journal` type | Yes | Yes | Yes |
| User-defined types | No | Yes | Yes |
| Explicit type creation | N/A | Yes | Yes |
| Typo detection | N/A | Yes | Yes |
| `--create` flag | N/A | Yes | Yes |
| Schema versioning | N/A | Yes | Yes |
| Type rename/delete | N/A | No | Yes |
| Migration tooling | No | No | Yes |

---

## 14. Open Questions (Deferred)

These are explicitly **out of scope** but planned:

* Computed / derived fields
* Schema inheritance
* Conditional fields
* Cross-entry references
* Multi-schema entries
* Schema import/export

---

## 15. Why This Design Works

This model:

* Prevents common user errors (typos, accidental schema creation)
* Maintains the ergonomic feel of schema-on-first-use (opt-in)
* Enables fast, frictionless journaling for the common case
* Scales to complex tracking use cases
* Preserves long-term data integrity
* Is explicitly phased for incremental delivery
